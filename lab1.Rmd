---
title: "lab1"
author: "204814891_204169320"
date: "14 4 2020"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
library('maps')
library('ggplot2')
library('mapproj')
library('nycflights13')
library('readr')
library('dplyr')
```


We loaded a  bunch of libararys that will help us later.
this includes then nycflights13 library that has the following data frames that we will use:
- flights 
- airlines 
- airports 
- planes 
- weather


Q1 

After we did some exloration (by ourselfes) of the data, let's answer Q 1:

1.1)
Delayed flights fig:
   This graphic is telling a clear story, it is telling us the percent of flights that are delayed by more then 15 minutes, from Denver Colorado to other destinatinos in the US. 
   
Weekly Cycles fig:

Q2
seif a:
- first thing we need is the number of flights, and number of delade flights each day

```{r}
flights$date <- format(flights$time_hour, '%D')
clean_flights <- na.omit(flights)
clean_flights$delayed <- ifelse(clean_flights$dep_delay > 15, 1, 0)
flights_per_day <- as.data.frame(table(factor(clean_flights$date)))
colnames(flights_per_day) <- c("date", "flights")
delayes_per_day <- clean_flights %>% group_by(date) %>% summarise(Tot.delayed = sum(delayed))
colnames(delayes_per_day) <- c("date", "delayes")
data4graph <- merge(flights_per_day, delayes_per_day)
data4graph$date <- as.Date(data4graph$date, "%m/%d/%Y")
```
After setting up all the data in the way we want it, all we need to do is plot!

```{r}
ggplot(data4graph) + geom_line(aes(x=date,y= flights, color = 'All flights (schedualed for separtue)')) + geom_bar(stat = "identity", aes(x = date, y = delayes, color = 'Late flights (departure delayed > 15 minutes)')) + theme(legend.position = "bottom") + scale_color_manual(name = "Colors", values = c('All flights (schedualed for separtue)' = "blue", 'Late flights (departure delayed > 15 minutes)' = "red")) + labs(title = "Weekly Cycles: Flights from NYC airports in 2013 \n  Few flights: Sundays & Saturdays \n Most Flights: Mondays, thursdays & fridays", y = "Flights per day") + theme(plot.title = element_text(hjust = 0.5))
```
Q2
seif b
```{r}
# > 15 min. delay
delays <- subset(flights, dep_delay > 15)
del_dest_count <- table(delays$dest)
dest_overall <- table(flights$dest)
```

We can see that we have 3 airports withot delays at all:
```{r}
dest_overall[!(names(table(flights$dest)) %in% names(table(delays$dest)))]
```
So we'll ignore them and then assign them manually 0%
```{r}
no_del <- rownames(dest_overall[!(names(table(flights$dest)) %in% names(table(delays$dest)))])
dest_overall <- dest_overall[names(table(flights$dest)) %in% names(table(delays$dest))]
# compute percentages
perc_delays <- as.data.frame(del_dest_count / dest_overall, row.names = TRUE)

# append and assign
to_append <- data.frame(rep(0,3))
colnames(to_append) <- 'Freq'
rownames(to_append) <- no_del
perc_delays <- rbind(perc_delays,to_append)
```

```{r}
# add perc. bins according to the example
perc_delays$bin = cut(perc_delays$Freq, 
                  c(0,0.1,0.15,0.20,0.25,1), right = FALSE, 
                  labels=c("<= 10%",
                           "10% - 15%",
                           "15% - 20%",
                           "15% - 25%",
                           "> 25%"))

#define JFK as the source (all 3 are pretty close in output graph)
perc_delays[,c('lon_source','lat_source')] <- subset(airports, faa=='JFK', select = c('lon','lat'))

```
during getting target coordinates, we discovered 4 airports which don't have coordinated in the airports dataframe:
```{r}
rownames(perc_delays)[!(rownames(perc_delays) %in% airports$faa)]
```
After Googling it we found they all located in Puerto Riko, so we could omit them relying on the assumption that the relevant data is located only in the main land of the U.S.A (same as Denver's plot in Moodle).

```{r}
perc_delays <- perc_delays[rownames(perc_delays) %in% airports$faa,]
```
Now, it's possible to get the target coordinates
```{r}
perc_delays[,c('lon_target','lat_target')] <- airports[airports$faa %in% rownames(perc_delays),c('lon','lat')]
```

plot
```{r message=FALSE, warning=FALSE}
USA <- subset(map_data("world"), region=="USA")
#USA <- subset(USA, lat < 50) remove alaska
states <- read_csv("states.csv") # state name with location
```



```{r}
plot <- 
  ggplot() +
  # plot usa with state borders and names
  geom_polygon(data = USA, aes(x=long, y = lat, group = group), fill="white", alpha=0.3) +
  borders("state") +
  geom_text(aes(x=longitude,y=latitude, label=state), data=states, size = 2) +
# plot filghts according to delays
geom_segment(data = perc_delays, aes(x=lon_source,y=lat_source, xend=lon_target, yend=lat_target, colour=bin)) +
geom_point(data=perc_delays,aes(x=lon_target,y=lat_target, colour=bin),shape=21,size=1.5, show.legend = FALSE) +

scale_fill_manual(values=rep("white",5)) + 
scale_colour_manual(values=c("forestgreen", "purple", "blue","orange","red"))
```

```{r warning=FALSE}
plot +
  ggtitle("% of Flights Departures Delayed > 15 Min", subtitle = "airport=NY's airports    Year=2013") +

  theme(legend.title = element_blank(), legend.position = c(0.22,0.1), panel.background = element_blank(), axis.line = element_blank(), axis.title = element_blank(), axis.ticks = element_blank(), axis.text = element_blank(),legend.text = element_text(size=7), legend.key = element_rect(fill = "transparent", colour = "transparent"), legend.key.height = unit(0.7,"line"), plot.title = element_text(hjust = 0.5, size=10, face="bold"), plot.subtitle = element_text(hjust = 0.5, size=6, face="bold")) +

    xlim(-130,-70) + 
    ylim(25,50) +
    coord_map()
```


Q 3:

Lets see if we can find delay trends by the time of year. 
first we will check if we can see a seasonal trend of the of the average dealy, as a function of the week in the year (weeks going from 1- 52)

```{r}
flights$date <-  as.POSIXct(flights$time_hour, "%m-%d-%Y")
flights$week <- lubridate::isoweek(flights$date)
# for this analysis we dont want negative delays, so we will zero them
flights$dep_delay[flights$dep_delay < 0] = 0
# now we have the week 
weekly_avg_dealy <- flights %>%
  select(month, day, week, dep_delay, carrier) %>%
  group_by(month) %>%
  summarise(average_delay <- mean(dep_delay, na.rm = 1) , sd(dep_delay, na.rm = 1)) %>%
  ungroup()
colnames(weekly_avg_dealy) <- c("month", "average_delay", "sd")
# now lets see some ploting:
ggplot(weekly_avg_dealy, aes(x = month, y = average_delay)) + 
  geom_point(color = "red") + #geom_errorbar(aes(ymin = average_delay-sd, ymax = average_delay+sd), color = "red", width = .1) +
  geom_smooth(color = "blue") + 
  ylim(0,30) + scale_x_continuous(breaks = c(1:12), labels = c("Jan","Feb","Mar","Apr", "May","Jun","Jul","Aug","Sep","Oct","Nov","Dec")) +
  geom_hline(aes(yintercept=0)) +
  labs(title = "Average delay of flights by month", x = "month", y = "average delay") + 
  theme(plot.title = element_text(hjust = 0.5))
```



